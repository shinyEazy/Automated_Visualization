<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Classification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .emotion-bar {
            transition: width 0.5s ease-in-out;
        }
        .emoji {
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">Emotion Classification</h1>
            <p class="text-gray-600 mt-2">Analyze the emotional tone of your text</p>
        </header>

        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Input Section -->
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Enter your text</h2>
                <textarea 
                    id="inputText" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                    rows="5" 
                    placeholder="Type or paste your text here..."></textarea>
                <div class="mt-4 flex justify-end">
                    <button 
                        id="analyzeBtn" 
                        class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                        Analyze Emotion
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Analysis Results</h2>
                
                <!-- Input Text -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-1">Input Text</h3>
                    <p id="displayText" class="text-gray-800 bg-gray-50 p-3 rounded"></p>
                </div>
                
                <!-- Predicted Emotion -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-1">Predicted Emotion</h3>
                    <div class="flex items-center">
                        <span id="predictedEmoji" class="emoji mr-3"></span>
                        <span id="predictedEmotion" class="text-xl font-semibold"></span>
                    </div>
                </div>
                
                <!-- Emotion Probabilities -->
                <div>
                    <h3 class="text-sm font-medium text-gray-500 mb-3">Emotion Probabilities</h3>
                    <div id="emotionBars" class="space-y-3">
                        <!-- Emotion bars will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden p-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600"></div>
                <p class="mt-2 text-gray-600">Analyzing emotions...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden p-6 bg-red-50 text-red-700 rounded-lg">
                <p id="errorText"></p>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="max-w-3xl mx-auto mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Previous Analyses</h2>
            <div id="historyList" class="space-y-4">
                <!-- History items will be added here -->
            </div>
        </div>
    </div>

    <script>
        // Emoji mapping for each emotion
        const emojiMap = {
            'anger': '😠',
            'disgust': '🤢',
            'fear': '😨',
            'joy': '😊',
            'neutral': '😐',
            'sadness': '😢',
            'surprise': '😲'
        };

        // Color mapping for each emotion
        const colorMap = {
            'anger': 'bg-red-500',
            'disgust': 'bg-green-600',
            'fear': 'bg-purple-500',
            'joy': 'bg-yellow-400',
            'neutral': 'bg-gray-400',
            'sadness': 'bg-blue-500',
            'surprise': 'bg-orange-400'
        };

        // Text color mapping for each emotion
        const textColorMap = {
            'anger': 'text-red-500',
            'disgust': 'text-green-600',
            'fear': 'text-purple-500',
            'joy': 'text-yellow-500',
            'neutral': 'text-gray-600',
            'sadness': 'text-blue-500',
            'surprise': 'text-orange-500'
        };

        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const inputText = document.getElementById('inputText');
            const resultsSection = document.getElementById('resultsSection');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const displayText = document.getElementById('displayText');
            const predictedEmotion = document.getElementById('predictedEmotion');
            const predictedEmoji = document.getElementById('predictedEmoji');
            const emotionBars = document.getElementById('emotionBars');
            const historyList = document.getElementById('historyList');

            analyzeBtn.addEventListener('click', analyzeEmotion);

            // Also trigger analysis when pressing Enter (but not Shift+Enter)
            inputText.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    analyzeEmotion();
                }
            });

            function analyzeEmotion() {
                const text = inputText.value.trim();
                
                if (!text) {
                    showError("Please enter some text to analyze.");
                    return;
                }

                // Show loading indicator and hide other sections
                loadingIndicator.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                errorMessage.classList.add('hidden');

                // Make API call to the emotion classification endpoint
                fetch('http://34.87.113.245:8000/api/text-classification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        texts: text
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code !== "000") {
                        throw new Error(data.message || "Unknown error from API");
                    }
                    
                    // Process the response
                    const emotions = data.data[0]; // Get the first (and only) result
                    displayResults(text, emotions);
                    addToHistory(text, emotions);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError(`Failed to analyze emotions: ${error.message}`);
                })
                .finally(() => {
                    loadingIndicator.classList.add('hidden');
                });
            }

            function displayResults(text, emotions) {
                // Display the input text
                displayText.textContent = text;
                
                // Find the emotion with the highest score
                const primaryEmotion = emotions.reduce((prev, current) => 
                    (prev.score > current.score) ? prev : current
                );
                
                // Display the primary emotion
                predictedEmotion.textContent = primaryEmotion.label;
                predictedEmotion.className = `text-xl font-semibold ${textColorMap[primaryEmotion.label]}`;
                predictedEmoji.textContent = emojiMap[primaryEmotion.label];
                
                // Create emotion probability bars
                emotionBars.innerHTML = '';
                emotions.forEach(emotion => {
                    const percentage = Math.round(emotion.score * 100);
                    
                    const barContainer = document.createElement('div');
                    barContainer.className = 'mb-2';
                    
                    const labelRow = document.createElement('div');
                    labelRow.className = 'flex justify-between text-sm mb-1';
                    
                    const label = document.createElement('span');
                    label.className = 'font-medium text-gray-700';
                    label.textContent = `${emojiMap[emotion.label]} ${emotion.label}`;
                    
                    const percentageLabel = document.createElement('span');
                    percentageLabel.className = 'font-medium';
                    percentageLabel.textContent = `${percentage}%`;
                    
                    labelRow.appendChild(label);
                    labelRow.appendChild(percentageLabel);
                    
                    const barBackground = document.createElement('div');
                    barBackground.className = 'w-full bg-gray-200 rounded-full h-2.5';
                    
                    const bar = document.createElement('div');
                    bar.className = `emotion-bar h-2.5 rounded-full ${colorMap[emotion.label]}`;
                    bar.style.width = '0%'; // Start at 0 for animation
                    
                    barBackground.appendChild(bar);
                    barContainer.appendChild(labelRow);
                    barContainer.appendChild(barBackground);
                    
                    emotionBars.appendChild(barContainer);
                    
                    // Animate the bar width
                    setTimeout(() => {
                        bar.style.width = `${percentage}%`;
                    }, 10);
                });
                
                // Show the results section
                resultsSection.classList.remove('hidden');
            }

            function addToHistory(text, emotions) {
                // Find the primary emotion
                const primaryEmotion = emotions.reduce((prev, current) => 
                    (prev.score > current.score) ? prev : current
                );
                
                // Create a history item
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow';
                
                // Truncate text for display
                const displayText = text.length > 100 ? text.substring(0, 100) + '...' : text;
                
                // Format probabilities for tooltip
                const probabilities = emotions.map(e => 
                    `${e.label}: ${Math.round(e.score * 100)}%`
                ).join('\n');
                
                historyItem.innerHTML = `
                    <div class="flex items-start">
                        <span class="emoji mr-3">${emojiMap[primaryEmotion.label]}</span>
                        <div class="flex-1">
                            <p class="text-gray-800 mb-1">${displayText}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm ${textColorMap[primaryEmotion.label]} font-medium">${primaryEmotion.label}</span>
                                <button class="text-xs text-indigo-600 hover:text-indigo-800" 
                                    onclick="this.nextElementSibling.classList.toggle('hidden')">
                                    Details
                                </button>
                            </div>
                            <div class="hidden mt-2 text-xs text-gray-600 whitespace-pre-line">${probabilities}</div>
                        </div>
                    </div>
                `;
                
                // Add to the top of the history list
                if (historyList.firstChild) {
                    historyList.insertBefore(historyItem, historyList.firstChild);
                } else {
                    historyList.appendChild(historyItem);
                }
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
